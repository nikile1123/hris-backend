# HRIS Back-end System

## Обзор
Данное приложение представляет собой бэкенд-систему управления персоналом (HRIS), разработанную на Kotlin с использованием Ktor, Exposed, Kodein DI и Micrometer для метрик. Для демонстрации реализована мультимодульная структура, где каждый сервис (**employees, reviews, notifications, rabbit-consumer**) собирается и деплоится отдельно, но в рамках одного репозитория. Такая организация позволяет в дальнейшем легко разделить приложение на отдельные микросервисы.

## Архитектурные решения и сервисы

### **Архитектурные решения**

#### **Мультимодульный монолит vs микросервисы**

**Мультимодульный монолит**:
- **Плюсы**: упрощённая разработка, единая кодовая база, простота локального запуска и отладки.
- **Минусы**: сложность масштабирования отдельных компонентов, потенциальные проблемы при изменениях, затрагивающих всю систему.

**Микросервисы (можно выделить в будущем)**:
- **Плюсы**: гибкое масштабирование, независимое развертывание, изоляция отказов.
- **Минусы**: сложность DevOps, необходимость надёжной коммуникации между сервисами, сложность управления данными.

Для демонстрационных целей выбран **мультимодульный монолит**, но все модули атамарны и собираются отдельно, при необходимости их легко вынести в отдельные репозитории.

Для обеспечения надежности уведомлений используется **паттерн Transactional Outbox**. При изменении данных в основных таблицах (например, создание или обновление сотрудника, создание ревью) в рамках одной транзакции добавляется запись в таблицу **outbox**, которая одновременно является аудитом. Сервис **notifications** является имплементацией Message Relay, которая считывает эти события и отправляет нотификации в RabbitMQ в соответствующие queue и с соответсвующими routing keys.
Таким образом гарантируется, что уведомление не потеряется и не продублируется. А также происходит изоляция логики занимающейся менеджментом ревью и сотрудников от логики отправки нотификаций пользователям.

---

### **Сервисы**

#### **Employees Service**
Отвечает за управление данными сотрудников и команд. Реализованы CRUD-операции, а также получение иерархии сотрудника (начальник, подчинённые, коллеги) и пагинация/сортировка списка сотрудников.

#### **Reviews Service**
CRUD-операции с перформанс-ревью и их и пагинация/сортировка. При создании ревью формируется событие в таблице **outbox**, которое затем используется для отправки персональных уведомлений сотруднику.

#### **Notifications Service**
Реализует паттерн **Transactional Outbox**: изменения в основных таблицах (**employees, reviews**) сопровождаются созданием записи в таблице **outbox**. Фоновый процесс (**Outbox Relay**) периодически считывает эти события и отправляет соответствующие уведомления через RabbitMQ с нужными **routing key**. Это гарантирует надёжную доставку уведомлений и повышает масштабируемость системы.

#### **Rabbit-consumer Service**
Клиент для RabbitMQ, который вычитывает сообщения из queue и выводит их в лог для демонстрации их получения.



## **Компоненты системы**
Приложение развёрнуто с использованием **Docker Compose**, который содержит следующие контейнеры:
- **Employees Service** – сервис для управления сотрудниками.
- **Reviews Service** – сервис для работы с перформанс-ревью.
- **Notifications Service** – сервис для обработки уведомлений (**Outbox Relay + RabbitMQ Consumer**).
- **RabbitMQ** – брокер сообщений для уведомлений.
- **PostgreSQL** – база данных.
- **Prometheus & Grafana** – система мониторинга и визуализации метрик.

---

## **Схема базы данных**

### **См. скрипт миграции (V1__init.sql)**



---

## **Бизнес-кейсы**

### **1. Персональное ревью**
**Сценарий**: при создании ревью формируется запись в **outbox**, затем Outbox Relay отправляет уведомление сотруднику.
**Запуск**: `POST /performance_reviews` – проверить создание записи в **outbox** и отправку уведомления.

### **2. Кадровые изменения**
**Сценарий**: при изменении данных сотрудника создаётся событие в **outbox**, которое затем передаётся команде через RabbitMQ.
**Запуск**: `POST /employees` – проверить создание записи в **outbox** и рассылку уведомлений.

### **3. Получение иерархии сотрудника**
**Сценарий**: запрос позволяет сотруднику получить начальника, подчинённых и коллег.
**Запуск**: `GET /employees/{id}/hierarchy`

---

## **Инструкция по запуску через Docker Compose**

1. **Запустить контейнеры**:
   ```sh
   docker-compose up -d
   ```
2. **Доступ к сервисам**:
- Employees Service: `http://localhost:8081`
- Reviews Service: `http://localhost:8082`
- Notifications Service: `http://localhost:8083`
- RabbitMQ Management: `http://localhost:15672` (логин: `guest`, пароль: `guest`)

---

## **Рекомендации по деплою и оптимизации**

### **Деплой на продакшене**
- **Load Balancer**: NGINX, HAProxy для распределения нагрузки.
- **Кэширование**: Redis для снижения нагрузки на БД.
- **Мониторинг**: Prometheus + Grafana для отслеживания метрик.
- **Отказоустойчивость**: Авто-скейлинг сервисов, репликация базы данных и RabbitMQ.

### **Оптимизация**
- **PostgreSQL**: индексы на часто запрашиваемые поля (`supervisor_id`).
- **RabbitMQ**: разные очереди для разных типов уведомлений.
- **Сервисы**: асинхронная обработка (корутины), `Transactional Outbox` для атомарности событий.

---

## **Заключение**
Проект демонстрирует комплексное HRIS-решение с поддержкой высоких нагрузок, отказоустойчивости и интеграцией с RabbitMQ. 

